{% extends 'base.html' %}

{% block title %}Edit Branch - Global IT{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h3><i class="fas fa-edit"></i> Edit Branch - {{ branch.branch_name }}</h3>
  <a href="{{ url_for('branch.list_branches') }}" class="btn btn-secondary">
    <i class="fas fa-arrow-left"></i> Back to Branches
  </a>
</div>

<div class="row justify-content-center">
  <div class="col-lg-10">
    <div class="card shadow">
      <div class="card-header bg-warning text-dark">
        <h5 class="mb-0"><i class="fas fa-info-circle"></i> Branch Code: {{ branch.branch_code }}</h5>
      </div>
      <div class="card-body">
        <form method="POST" id="branchForm">
          
          <!-- Basic Information -->
          <div class="row mb-4">
            <div class="col-12">
              <h5 class="text-primary border-bottom pb-2"><i class="fas fa-info-circle"></i> Basic Information</h5>
            </div>
          </div>
          
          <div class="row g-3 mb-4">
            <div class="col-md-8">
              <label class="form-label"><strong>Branch Name</strong> <span class="text-danger">*</span></label>
              <input type="text" name="branch_name" class="form-control" required 
                     value="{{ branch.branch_name }}" placeholder="e.g., Global IT - Hoskote Branch">
            </div>
            <div class="col-md-4">
              <label class="form-label"><strong>Branch Type</strong> <span class="text-danger">*</span></label>
              <select name="branch_type" class="form-select" required>
                <option value="Franchise" {{ 'selected' if branch.branch_type == 'Franchise' else '' }}>Franchise</option>
                <option value="Corporate" {{ 'selected' if branch.branch_type == 'Corporate' else '' }}>Corporate Owned</option>
              </select>
            </div>
          </div>

          <!-- Location Details -->
          <div class="row mb-4">
            <div class="col-12">
              <h5 class="text-primary border-bottom pb-2"><i class="fas fa-map-marker-alt"></i> Location Details</h5>
            </div>
          </div>
          
          <div class="row g-3 mb-4">
            <div class="col-12">
              <label class="form-label"><strong>Complete Address</strong> <span class="text-danger">*</span></label>
              <textarea name="address" class="form-control" rows="3" required 
                        placeholder="Enter complete branch address">{{ branch.address }}</textarea>
            </div>
            <div class="col-md-4">
              <label class="form-label"><strong>City</strong> <span class="text-danger">*</span></label>
              <input type="text" name="city" class="form-control" required 
                     value="{{ branch.city }}" placeholder="City">
            </div>
            <div class="col-md-4">
              <label class="form-label"><strong>State</strong> <span class="text-danger">*</span></label>
              <select name="state" class="form-select" required>
                <option value="">Select State</option>
                <option value="Karnataka" {{ 'selected' if branch.state == 'Karnataka' else '' }}>Karnataka</option>
                <option value="Tamil Nadu" {{ 'selected' if branch.state == 'Tamil Nadu' else '' }}>Tamil Nadu</option>
                <option value="Andhra Pradesh" {{ 'selected' if branch.state == 'Andhra Pradesh' else '' }}>Andhra Pradesh</option>
                <option value="Telangana" {{ 'selected' if branch.state == 'Telangana' else '' }}>Telangana</option>
                <option value="Kerala" {{ 'selected' if branch.state == 'Kerala' else '' }}>Kerala</option>
                <option value="Maharashtra" {{ 'selected' if branch.state == 'Maharashtra' else '' }}>Maharashtra</option>
                <option value="Gujarat" {{ 'selected' if branch.state == 'Gujarat' else '' }}>Gujarat</option>
                <option value="Rajasthan" {{ 'selected' if branch.state == 'Rajasthan' else '' }}>Rajasthan</option>
                <option value="Punjab" {{ 'selected' if branch.state == 'Punjab' else '' }}>Punjab</option>
                <option value="Haryana" {{ 'selected' if branch.state == 'Haryana' else '' }}>Haryana</option>
                <option value="Uttar Pradesh" {{ 'selected' if branch.state == 'Uttar Pradesh' else '' }}>Uttar Pradesh</option>
                <option value="Madhya Pradesh" {{ 'selected' if branch.state == 'Madhya Pradesh' else '' }}>Madhya Pradesh</option>
                <option value="Delhi" {{ 'selected' if branch.state == 'Delhi' else '' }}>Delhi</option>
                <option value="Other" {{ 'selected' if branch.state == 'Other' else '' }}>Other</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label"><strong>Pincode</strong> <span class="text-danger">*</span></label>
              <input type="text" name="pincode" class="form-control" required 
                     pattern="[0-9]{6}" maxlength="6" value="{{ branch.pincode }}" 
                     placeholder="6-digit pincode">
            </div>
          </div>

          <!-- Contact Information -->
          <div class="row mb-4">
            <div class="col-12">
              <h5 class="text-primary border-bottom pb-2"><i class="fas fa-phone"></i> Contact Information</h5>
            </div>
          </div>
          
          <div class="row g-3 mb-4">
            <div class="col-md-6">
              <label class="form-label"><strong>Branch Phone</strong> <span class="text-danger">*</span></label>
              <input type="tel" name="phone" class="form-control" required 
                     pattern="[0-9]{10}" maxlength="10" value="{{ branch.phone }}" 
                     placeholder="10-digit phone number">
            </div>
            <div class="col-md-6">
              <label class="form-label"><strong>Branch Email</strong></label>
              <input type="email" name="email" class="form-control" value="{{ branch.email }}" 
                     placeholder="branch@globaliteducation.com">
            </div>
          </div>

          <!-- Manager Information -->
          <div class="row mb-4">
            <div class="col-12">
              <h5 class="text-primary border-bottom pb-2"><i class="fas fa-user-tie"></i> Branch Manager Information</h5>
            </div>
          </div>
          
          <div class="row g-3 mb-4">
            <div class="col-md-6">
              <label class="form-label"><strong>Manager Name</strong> <span class="text-danger">*</span></label>
              <input type="text" name="manager_name" class="form-control" required 
                     value="{{ branch.manager_name }}" placeholder="Branch manager full name">
            </div>
            <div class="col-md-6">
              <label class="form-label"><strong>Manager Phone</strong> <span class="text-danger">*</span></label>
              <input type="tel" name="manager_phone" class="form-control" required 
                     pattern="[0-9]{10}" maxlength="10" value="{{ branch.manager_phone }}" 
                     placeholder="10-digit phone number">
            </div>
          </div>

          <!-- Business Details -->
          <div class="row mb-4">
            <div class="col-12">
              <h5 class="text-primary border-bottom pb-2"><i class="fas fa-business-time"></i> Business Details</h5>
            </div>
          </div>
          
          <div class="row g-3 mb-4">
            <div class="col-md-4">
              <label class="form-label"><strong>Opening Date</strong></label>
              <input type="date" name="opening_date" class="form-control" 
                     value="{{ branch.opening_date.strftime('%Y-%m-%d') if branch.opening_date else '' }}">
            </div>
            <div class="col-md-4">
              <label class="form-label"><strong>Status</strong></label>
              <select name="status" class="form-select">
                <option value="Active" {{ 'selected' if branch.status == 'Active' else '' }}>Active</option>
                <option value="Inactive" {{ 'selected' if branch.status == 'Inactive' else '' }}>Inactive</option>
                <option value="Suspended" {{ 'selected' if branch.status == 'Suspended' else '' }}>Suspended</option>
              </select>
            </div>
            <div class="col-md-4">
              <!-- Spacer for better layout -->
            </div>
          </div>

          <!-- Franchise Financial Details (shown only for franchises) -->
          <div id="franchiseDetails" class="franchise-only" style="display: {{ 'block' if branch.branch_type == 'Franchise' else 'none' }};">
            <div class="row mb-4">
              <div class="col-12">
                <h5 class="text-primary border-bottom pb-2"><i class="fas fa-rupee-sign"></i> Franchise Financial Details</h5>
              </div>
            </div>
            
            <div class="row g-3 mb-4">
              <div class="col-md-6">
                <label class="form-label"><strong>One-time Franchise Fee</strong></label>
                <div class="input-group">
                  <span class="input-group-text">₹</span>
                  <input type="number" name="franchise_fee" class="form-control" 
                         step="0.01" min="0" value="{{ branch.franchise_fee or 0 }}" placeholder="0.00">
                </div>
              </div>
              <div class="col-md-6">
                <label class="form-label"><strong>Monthly License Fee</strong></label>
                <div class="input-group">
                  <span class="input-group-text">₹</span>
                  <input type="number" name="monthly_fee" class="form-control" 
                         step="0.01" min="0" value="{{ branch.monthly_fee or 0 }}" placeholder="0.00">
                </div>
              </div>
            </div>
          </div>

          <!-- Legal Information -->
          <div class="row mb-4">
            <div class="col-12">
              <h5 class="text-primary border-bottom pb-2"><i class="fas fa-file-contract"></i> Legal Information</h5>
            </div>
          </div>
          
          <div class="row g-3 mb-4">
            <div class="col-md-6">
              <label class="form-label"><strong>GST Number</strong></label>
              <input type="text" name="gst_number" class="form-control" 
                     pattern="[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}Z[0-9A-Z]{1}" 
                     maxlength="15" value="{{ branch.gst_number }}" placeholder="15-digit GST number">
              <div class="form-text">Format: 22AAAAA0000A1Z5</div>
            </div>
            <div class="col-md-6">
              <label class="form-label"><strong>PAN Number</strong></label>
              <input type="text" name="pan_number" class="form-control" 
                     pattern="[A-Z]{5}[0-9]{4}[A-Z]{1}" 
                     maxlength="10" value="{{ branch.pan_number }}" placeholder="10-character PAN">
              <div class="form-text">Format: ABCDE1234F</div>
            </div>
          </div>

          <!-- Submit Buttons -->
          <div class="row">
            <div class="col-12">
              <div class="d-flex justify-content-end gap-2">
                <a href="{{ url_for('branch.list_branches') }}" class="btn btn-secondary">
                  <i class="fas fa-times"></i> Cancel
                </a>
                <button type="submit" class="btn btn-warning">
                  <i class="fas fa-save"></i> Update Branch
                </button>
              </div>
            </div>
          </div>
          
        </form>
      </div>
    </div>
  </div>
</div>

<script>
// Toggle franchise details based on branch type
document.querySelector('select[name="branch_type"]').addEventListener('change', function() {
  const franchiseDetails = document.getElementById('franchiseDetails');
  if (this.value === 'Franchise') {
    franchiseDetails.style.display = 'block';
  } else {
    franchiseDetails.style.display = 'none';
    // Clear franchise fee fields for corporate branches
    document.querySelector('input[name="franchise_fee"]').value = '0';
    document.querySelector('input[name="monthly_fee"]').value = '0';
  }
});

// Form validation (same as create form)
document.getElementById('branchForm').addEventListener('submit', function(e) {
  let isValid = true;
  let errorMessages = [];

  // Phone number validation
  const phone = document.querySelector('input[name="phone"]').value;
  if (!/^\d{10}$/.test(phone)) {
    errorMessages.push("Branch phone must be exactly 10 digits");
    isValid = false;
  }

  const managerPhone = document.querySelector('input[name="manager_phone"]').value;
  if (!/^\d{10}$/.test(managerPhone)) {
    errorMessages.push("Manager phone must be exactly 10 digits");
    isValid = false;
  }

  // Pincode validation
  const pincode = document.querySelector('input[name="pincode"]').value;
  if (!/^\d{6}$/.test(pincode)) {
    errorMessages.push("Pincode must be exactly 6 digits");
    isValid = false;
  }

  // GST number validation (if provided)
  const gstNumber = document.querySelector('input[name="gst_number"]').value;
  if (gstNumber && !/^[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}Z[0-9A-Z]{1}$/.test(gstNumber)) {
    errorMessages.push("Invalid GST number format");
    isValid = false;
  }

  // PAN number validation (if provided)
  const panNumber = document.querySelector('input[name="pan_number"]').value;
  if (panNumber && !/^[A-Z]{5}[0-9]{4}[A-Z]{1}$/.test(panNumber)) {
    errorMessages.push("Invalid PAN number format");
    isValid = false;
  }

  if (!isValid) {
    e.preventDefault();
    alert('Please fix the following errors:\n' + errorMessages.join('\n'));
  }
});

// Auto-format inputs
document.querySelector('input[name="gst_number"]').addEventListener('input', function() {
  this.value = this.value.toUpperCase();
});

document.querySelector('input[name="pan_number"]').addEventListener('input', function() {
  this.value = this.value.toUpperCase();
});
</script>
{% endblock %}
