{% extends "base.html" %}
{% block title %}Edit Expense - {{ expense.expense_id }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="text-primary">
                        <i class="fas fa-edit me-2"></i>Edit Expense
                    </h2>
                    <p class="text-secondary mb-0">{{ expense.expense_id }}</p>
                </div>
                <div>
                    <a href="{{ url_for('expenses.view_expense', expense_id=expense.expense_id) }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i>Back to Details
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Form -->
    <form method="POST" enctype="multipart/form-data" id="editExpenseForm">
        <div class="row">
            <!-- Left Column -->
            <div class="col-lg-8">
                <!-- Basic Information -->
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 fw-bold text-primary">Basic Information</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="expense_date" class="form-label">Expense Date <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="expense_date" name="expense_date" 
                                       value="{{ expense.expense_date.strftime('%Y-%m-%d') if expense.expense_date else '' }}" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="expense_category" class="form-label">Category <span class="text-danger">*</span></label>
                                <select class="form-select" id="expense_category" name="expense_category" required>
                                    <option value="">Select Category</option>
                                    <option value="Office Supplies" {{ 'selected' if expense.expense_category == 'Office Supplies' else '' }}>Office Supplies</option>
                                    <option value="Travel & Transport" {{ 'selected' if expense.expense_category == 'Travel & Transport' else '' }}>Travel & Transport</option>
                                    <option value="Marketing & Advertising" {{ 'selected' if expense.expense_category == 'Marketing & Advertising' else '' }}>Marketing & Advertising</option>
                                    <option value="Utilities" {{ 'selected' if expense.expense_category == 'Utilities' else '' }}>Utilities</option>
                                    <option value="Equipment & Technology" {{ 'selected' if expense.expense_category == 'Equipment & Technology' else '' }}>Equipment & Technology</option>
                                    <option value="Professional Services" {{ 'selected' if expense.expense_category == 'Professional Services' else '' }}>Professional Services</option>
                                    <option value="Training & Development" {{ 'selected' if expense.expense_category == 'Training & Development' else '' }}>Training & Development</option>
                                    <option value="Meals & Entertainment" {{ 'selected' if expense.expense_category == 'Meals & Entertainment' else '' }}>Meals & Entertainment</option>
                                    <option value="Rent & Facility" {{ 'selected' if expense.expense_category == 'Rent & Facility' else '' }}>Rent & Facility</option>
                                    <option value="Insurance" {{ 'selected' if expense.expense_category == 'Insurance' else '' }}>Insurance</option>
                                    <option value="Maintenance & Repairs" {{ 'selected' if expense.expense_category == 'Maintenance & Repairs' else '' }}>Maintenance & Repairs</option>
                                    <option value="Miscellaneous" {{ 'selected' if expense.expense_category == 'Miscellaneous' else '' }}>Miscellaneous</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="description" class="form-label">Description <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="description" name="description" rows="3" required>{{ expense.description }}</textarea>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="vendor_supplier" class="form-label">Vendor/Supplier</label>
                                <input type="text" class="form-control" id="vendor_supplier" name="vendor_supplier" 
                                       value="{{ expense.vendor_supplier or '' }}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="invoice_bill_number" class="form-label">Invoice/Bill Number</label>
                                <input type="text" class="form-control" id="invoice_bill_number" name="invoice_bill_number" 
                                       value="{{ expense.invoice_bill_number or '' }}">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Amount and Tax Information -->
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 fw-bold text-success">Amount & Tax Information</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="amount" class="form-label">Base Amount (₹) <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="amount" name="amount" step="0.01" 
                                       value="{{ '%.2f'|format(expense.amount) }}" required onchange="calculateTotal()">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="gst_percentage" class="form-label">GST Percentage (%)</label>
                                <select class="form-select" id="gst_percentage" name="gst_percentage" onchange="calculateTotal()">
                                    <option value="0" {{ 'selected' if expense.gst_percentage == 0 else '' }}>0% (No GST)</option>
                                    <option value="5" {{ 'selected' if expense.gst_percentage == 5 else '' }}>5%</option>
                                    <option value="12" {{ 'selected' if expense.gst_percentage == 12 else '' }}>12%</option>
                                    <option value="18" {{ 'selected' if expense.gst_percentage == 18 else '' }}>18%</option>
                                    <option value="28" {{ 'selected' if expense.gst_percentage == 28 else '' }}>28%</option>
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="gst_amount" class="form-label">GST Amount (₹)</label>
                                <input type="number" class="form-control" id="gst_amount" name="gst_amount" step="0.01" 
                                       value="{{ '%.2f'|format(expense.gst_amount) }}" readonly>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="total_amount" class="form-label">Total Amount (₹) <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="total_amount" name="total_amount" step="0.01" 
                                       value="{{ '%.2f'|format(expense.total_amount) }}" readonly>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payment Information -->
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 fw-bold text-warning">Payment Information</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="payment_method" class="form-label">Payment Method <span class="text-danger">*</span></label>
                                <select class="form-select" id="payment_method" name="payment_method" required>
                                    <option value="">Select Payment Method</option>
                                    <option value="Cash" {{ 'selected' if expense.payment_method == 'Cash' else '' }}>Cash</option>
                                    <option value="Bank Transfer" {{ 'selected' if expense.payment_method == 'Bank Transfer' else '' }}>Bank Transfer</option>
                                    <option value="Credit Card" {{ 'selected' if expense.payment_method == 'Credit Card' else '' }}>Credit Card</option>
                                    <option value="Debit Card" {{ 'selected' if expense.payment_method == 'Debit Card' else '' }}>Debit Card</option>
                                    <option value="Cheque" {{ 'selected' if expense.payment_method == 'Cheque' else '' }}>Cheque</option>
                                    <option value="UPI" {{ 'selected' if expense.payment_method == 'UPI' else '' }}>UPI</option>
                                    <option value="Digital Wallet" {{ 'selected' if expense.payment_method == 'Digital Wallet' else '' }}>Digital Wallet</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="payment_status" class="form-label">Payment Status <span class="text-danger">*</span></label>
                                <select class="form-select" id="payment_status" name="payment_status" required>
                                    <option value="">Select Payment Status</option>
                                    <option value="Paid" {{ 'selected' if expense.payment_status == 'Paid' else '' }}>Paid</option>
                                    <option value="Partially Paid" {{ 'selected' if expense.payment_status == 'Partially Paid' else '' }}>Partially Paid</option>
                                    <option value="Unpaid" {{ 'selected' if expense.payment_status == 'Unpaid' else '' }}>Unpaid</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Optional Details -->
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 fw-bold text-info">Optional Details</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="linked_ledger_account" class="form-label">Linked Ledger Account</label>
                                <input type="text" class="form-control" id="linked_ledger_account" name="linked_ledger_account" 
                                       value="{{ expense.linked_ledger_account or '' }}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="branch_location" class="form-label">Branch/Location</label>
                                <select class="form-select" id="branch_location" name="branch_location">
                                    <option value="">Select Branch</option>
                                    <option value="Pune" {{ 'selected' if expense.branch_location == 'Pune' else '' }}>Pune</option>
                                    <option value="Mumbai" {{ 'selected' if expense.branch_location == 'Mumbai' else '' }}>Mumbai</option>
                                    <option value="Delhi" {{ 'selected' if expense.branch_location == 'Delhi' else '' }}>Delhi</option>
                                    <option value="Bangalore" {{ 'selected' if expense.branch_location == 'Bangalore' else '' }}>Bangalore</option>
                                    <option value="Chennai" {{ 'selected' if expense.branch_location == 'Chennai' else '' }}>Chennai</option>
                                    <option value="Hyderabad" {{ 'selected' if expense.branch_location == 'Hyderabad' else '' }}>Hyderabad</option>
                                    <option value="Kolkata" {{ 'selected' if expense.branch_location == 'Kolkata' else '' }}>Kolkata</option>
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="department_project" class="form-label">Department/Project</label>
                                <select class="form-select" id="department_project" name="department_project">
                                    <option value="">Select Department</option>
                                    <option value="Administration" {{ 'selected' if expense.department_project == 'Administration' else '' }}>Administration</option>
                                    <option value="Training" {{ 'selected' if expense.department_project == 'Training' else '' }}>Training</option>
                                    <option value="Marketing" {{ 'selected' if expense.department_project == 'Marketing' else '' }}>Marketing</option>
                                    <option value="Operations" {{ 'selected' if expense.department_project == 'Operations' else '' }}>Operations</option>
                                    <option value="Finance" {{ 'selected' if expense.department_project == 'Finance' else '' }}>Finance</option>
                                    <option value="HR" {{ 'selected' if expense.department_project == 'HR' else '' }}>HR</option>
                                    <option value="IT" {{ 'selected' if expense.department_project == 'IT' else '' }}>IT</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="approval_status" class="form-label">Approval Status</label>
                                <select class="form-select" id="approval_status" name="approval_status">
                                    <option value="Pending" {{ 'selected' if expense.approval_status == 'Pending' else '' }}>Pending</option>
                                    <option value="Approved" {{ 'selected' if expense.approval_status == 'Approved' else '' }}>Approved</option>
                                    <option value="Rejected" {{ 'selected' if expense.approval_status == 'Rejected' else '' }}>Rejected</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="notes" class="form-label">Notes</label>
                            <textarea class="form-control" id="notes" name="notes" rows="3">{{ expense.notes or '' }}</textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label for="change_reason" class="form-label">Reason for Changes <span class="text-muted">(For Audit Trail)</span></label>
                            <textarea class="form-control" id="change_reason" name="change_reason" rows="2" 
                                      placeholder="Describe why you are making these changes..."></textarea>
                            <small class="form-text text-muted">This will be recorded in the audit trail for accountability.</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column - Summary and Actions -->
            <div class="col-lg-4">
                <!-- Amount Summary -->
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 fw-bold text-success">Amount Summary</h6>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">Base Amount:</span>
                            <span class="fw-bold" id="display_amount">₹ {{ '%.2f'|format(expense.amount) }}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">GST:</span>
                            <span id="display_gst">₹ {{ '%.2f'|format(expense.gst_amount) }}</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between">
                            <span class="fw-bold text-success">Total:</span>
                            <span class="fw-bold text-success fs-5" id="display_total">₹ {{ '%.2f'|format(expense.total_amount) }}</span>
                        </div>
                    </div>
                </div>

                <!-- Current Attachment -->
                {% if expense.attachment_filename %}
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 fw-bold text-info">Current Attachment</h6>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-file-alt fa-2x text-info"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <div class="fw-bold">{{ expense.attachment_filename }}</div>
                                <div class="text-muted small">Current file</div>
                            </div>
                            <div>
                                <a href="{{ url_for('expenses.download_attachment', expense_id=expense.expense_id) }}" 
                                   class="btn btn-sm btn-outline-info">
                                    <i class="fas fa-download"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- File Upload -->
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 fw-bold text-info">
                            {% if expense.attachment_filename %}Replace{% else %}Add{% endif %} Attachment
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <input type="file" class="form-control" id="attachment" name="attachment" 
                                   accept=".pdf,.jpg,.jpeg,.png" onchange="validateFile(this)">
                            <div class="form-text">
                                Supported formats: PDF, JPG, JPEG, PNG<br>
                                Maximum file size: 5MB
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="card shadow">
                    <div class="card-header py-3">
                        <h6 class="m-0 fw-bold text-primary">Actions</h6>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i>Update Expense
                            </button>
                            <a href="{{ url_for('expenses.view_expense', expense_id=expense.expense_id) }}" 
                               class="btn btn-secondary">
                                <i class="fas fa-times me-1"></i>Cancel
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
function calculateTotal() {
    const amount = parseFloat(document.getElementById('amount').value) || 0;
    const gstPercentage = parseFloat(document.getElementById('gst_percentage').value) || 0;
    
    const gstAmount = (amount * gstPercentage) / 100;
    const totalAmount = amount + gstAmount;
    
    // Update form fields
    document.getElementById('gst_amount').value = gstAmount.toFixed(2);
    document.getElementById('total_amount').value = totalAmount.toFixed(2);
    
    // Update display
    document.getElementById('display_amount').textContent = '₹ ' + amount.toFixed(2);
    document.getElementById('display_gst').textContent = '₹ ' + gstAmount.toFixed(2);
    document.getElementById('display_total').textContent = '₹ ' + totalAmount.toFixed(2);
}

function validateFile(input) {
    const file = input.files[0];
    if (file) {
        const allowedTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png'];
        const maxSize = 5 * 1024 * 1024; // 5MB
        
        if (!allowedTypes.includes(file.type)) {
            alert('Please select a valid file type (PDF, JPG, JPEG, PNG)');
            input.value = '';
            return false;
        }
        
        if (file.size > maxSize) {
            alert('File size must be less than 5MB');
            input.value = '';
            return false;
        }
    }
    return true;
}

// Initialize calculations on page load
document.addEventListener('DOMContentLoaded', function() {
    calculateTotal();
});
</script>
{% endblock %}
