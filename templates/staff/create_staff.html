{% extends "base.html" %}
{% block title %}Create New Staff Member{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/app.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/staff-management.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="text-primary">
                        <i class="fas fa-user-plus me-2"></i>Create New Staff Member
                    </h2>
                    <p class="text-muted mb-0">Add comprehensive staff details and profile information</p>
                </div>
                <div>
                    <a href="{{ url_for('staff.list_staff') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i>Back to Staff List
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Form Wizard -->
    <div class="form-wizard">
        <!-- Progress Indicator -->
        <div class="progress-indicator">
            <div class="progress-bar-custom" id="progressBar" style="width: 20%"></div>
        </div>

        <!-- Wizard Navigation -->
        <ul class="nav nav-tabs wizard-nav justify-content-center" id="wizardNav">
            <li class="nav-item">
                <a class="nav-link active" data-step="1">
                    <i class="fas fa-user me-1"></i>Basic Info
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-step="2">
                    <i class="fas fa-id-card me-1"></i>Personal Details
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-step="3">
                    <i class="fas fa-briefcase me-1"></i>Professional Info
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-step="4">
                    <i class="fas fa-file-upload me-1"></i>Documents
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-step="5">
                    <i class="fas fa-check-circle me-1"></i>Review & Submit
                </a>
            </li>
        </ul>

        <!-- Wizard Form -->
        <form id="createStaffForm" action="{{ url_for('staff.create_staff_post') }}" method="POST" enctype="multipart/form-data">
            <!-- Step 1: Basic Information -->
            <div class="wizard-step active" data-step="1">
                <div class="row">
                    <div class="col-lg-8 mx-auto">
                        <div class="form-section">
                            <h6><i class="fas fa-user-circle"></i>Account & Login Information</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="username" class="form-label">Username <span class="required">*</span></label>
                                        <input type="text" class="form-control" id="username" name="username" 
                                               required pattern="[a-zA-Z0-9_]+" title="Username can only contain letters, numbers, and underscores">
                                        <div class="field-help">Only letters, numbers, and underscores allowed</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="full_name" class="form-label">Full Name <span class="required">*</span></label>
                                        <input type="text" class="form-control" id="full_name" name="full_name" required>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="password" class="form-label">Password <span class="required">*</span></label>
                                        <input type="password" class="form-control" id="password" name="password" 
                                               required minlength="6">
                                        <div class="field-help">Minimum 6 characters</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="confirm_password" class="form-label">Confirm Password <span class="required">*</span></label>
                                        <input type="password" class="form-control" id="confirm_password" name="confirm_password" 
                                               required minlength="6">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h6><i class="fas fa-user-tag"></i>Role & Assignment</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="role" class="form-label">Role <span class="required">*</span></label>
                                        <select class="form-select" id="role" name="role" required>
                                            <option value="">Select Role</option>
                                            <option value="trainer">Trainer</option>
                                            <option value="branch_manager">Branch Manager</option>
                                            <option value="staff">Support Staff</option>
                                            {% if user_role == 'admin' %}
                                            <option value="franchise">Franchise Owner</option>
                                            <option value="regional_manager">Regional Manager</option>
                                            {% endif %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="designation" class="form-label">Designation</label>
                                        <input type="text" class="form-control" id="designation" name="designation" 
                                               placeholder="e.g. Senior Trainer, Assistant Manager">
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="branch_ids" class="form-label">Assign to Branches <span class="required">*</span></label>
                                <select class="form-select" id="branch_ids" name="branch_ids[]" multiple required>
                                    {% for branch in available_branches %}
                                    <option value="{{ branch.id }}">{{ branch.branch_name }} - {{ branch.location }}</option>
                                    {% endfor %}
                                </select>
                                <div class="field-help">Hold Ctrl/Cmd to select multiple branches</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Personal Details -->
            <div class="wizard-step" data-step="2">
                <div class="row">
                    <div class="col-lg-8 mx-auto">
                        <div class="form-section">
                            <h6><i class="fas fa-id-card"></i>Personal Information</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="date_of_birth" class="form-label">Date of Birth</label>
                                        <input type="date" class="form-control" id="date_of_birth" name="date_of_birth">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="gender" class="form-label">Gender</label>
                                        <select class="form-select" id="gender" name="gender">
                                            <option value="">Select Gender</option>
                                            <option value="Male">Male</option>
                                            <option value="Female">Female</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="marital_status" class="form-label">Marital Status</label>
                                        <select class="form-select" id="marital_status" name="marital_status">
                                            <option value="">Select Status</option>
                                            <option value="Single">Single</option>
                                            <option value="Married">Married</option>
                                            <option value="Divorced">Divorced</option>
                                            <option value="Widowed">Widowed</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="blood_group" class="form-label">Blood Group</label>
                                        <select class="form-select" id="blood_group" name="blood_group">
                                            <option value="">Select Blood Group</option>
                                            <option value="A+">A+</option>
                                            <option value="A-">A-</option>
                                            <option value="B+">B+</option>
                                            <option value="B-">B-</option>
                                            <option value="AB+">AB+</option>
                                            <option value="AB-">AB-</option>
                                            <option value="O+">O+</option>
                                            <option value="O-">O-</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h6><i class="fas fa-phone"></i>Contact Information</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="primary_mobile" class="form-label">Primary Mobile <span class="required">*</span></label>
                                        <input type="tel" class="form-control" id="primary_mobile" name="primary_mobile" 
                                               required pattern="[0-9]{10}" title="Please enter a 10-digit mobile number">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="secondary_mobile" class="form-label">Secondary Mobile</label>
                                        <input type="tel" class="form-control" id="secondary_mobile" name="secondary_mobile" 
                                               pattern="[0-9]{10}" title="Please enter a 10-digit mobile number">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="personal_email" class="form-label">Personal Email</label>
                                        <input type="email" class="form-control" id="personal_email" name="personal_email">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="official_email" class="form-label">Official Email</label>
                                        <input type="email" class="form-control" id="official_email" name="official_email">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h6><i class="fas fa-map-marker-alt"></i>Address Information</h6>
                            <div class="mb-3">
                                <label for="current_address" class="form-label">Current Address</label>
                                <textarea class="form-control" id="current_address" name="current_address" rows="3"></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="permanent_address" class="form-label">Permanent Address</label>
                                <textarea class="form-control" id="permanent_address" name="permanent_address" rows="3"></textarea>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="city" class="form-label">City</label>
                                        <input type="text" class="form-control" id="city" name="city">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="state" class="form-label">State</label>
                                        <input type="text" class="form-control" id="state" name="state">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="pincode" class="form-label">Pincode</label>
                                        <input type="text" class="form-control" id="pincode" name="pincode" 
                                               pattern="[0-9]{6}" title="Please enter a 6-digit pincode">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h6><i class="fas fa-exclamation-triangle"></i>Emergency Contact</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="emergency_contact_name" class="form-label">Emergency Contact Name</label>
                                        <input type="text" class="form-control" id="emergency_contact_name" name="emergency_contact_name">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="emergency_contact_relation" class="form-label">Relation</label>
                                        <input type="text" class="form-control" id="emergency_contact_relation" name="emergency_contact_relation" 
                                               placeholder="e.g. Father, Mother, Spouse">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="emergency_contact_mobile" class="form-label">Emergency Contact Mobile</label>
                                        <input type="tel" class="form-control" id="emergency_contact_mobile" name="emergency_contact_mobile" 
                                               pattern="[0-9]{10}" title="Please enter a 10-digit mobile number">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="emergency_contact_address" class="form-label">Emergency Contact Address</label>
                                        <input type="text" class="form-control" id="emergency_contact_address" name="emergency_contact_address">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 3: Professional Information -->
            <div class="wizard-step" data-step="3">
                <div class="row">
                    <div class="col-lg-8 mx-auto">
                        <div class="form-section">
                            <h6><i class="fas fa-briefcase"></i>Employment Details</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="joining_date" class="form-label">Joining Date</label>
                                        <input type="date" class="form-control" id="joining_date" name="joining_date">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="employment_type" class="form-label">Employment Type</label>
                                        <select class="form-select" id="employment_type" name="employment_type">
                                            <option value="">Select Type</option>
                                            <option value="Full-time">Full-time</option>
                                            <option value="Part-time">Part-time</option>
                                            <option value="Contract">Contract</option>
                                            <option value="Freelance">Freelance</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="department" class="form-label">Department</label>
                                        <input type="text" class="form-control" id="department" name="department" 
                                               placeholder="e.g. Training, Administration">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="years_of_experience" class="form-label">Years of Experience</label>
                                        <input type="number" class="form-control" id="years_of_experience" name="years_of_experience" 
                                               min="0" max="50">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h6><i class="fas fa-graduation-cap"></i>Education & Qualifications</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="highest_qualification" class="form-label">Highest Qualification</label>
                                        <select class="form-select" id="highest_qualification" name="highest_qualification">
                                            <option value="">Select Qualification</option>
                                            <option value="10th">10th Standard</option>
                                            <option value="12th">12th Standard</option>
                                            <option value="Diploma">Diploma</option>
                                            <option value="Bachelor's">Bachelor's Degree</option>
                                            <option value="Master's">Master's Degree</option>
                                            <option value="PhD">PhD</option>
                                            <option value="Professional">Professional Certification</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="specialization" class="form-label">Specialization</label>
                                        <input type="text" class="form-control" id="specialization" name="specialization" 
                                               placeholder="e.g. Computer Science, Commerce">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="university_college" class="form-label">University/College</label>
                                        <input type="text" class="form-control" id="university_college" name="university_college">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="graduation_year" class="form-label">Graduation Year</label>
                                        <input type="number" class="form-control" id="graduation_year" name="graduation_year" 
                                               min="1980" max="2030">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h6><i class="fas fa-tools"></i>Skills & Expertise</h6>
                            <div class="mb-3">
                                <label for="technical_skills" class="form-label">Technical Skills</label>
                                <textarea class="form-control" id="technical_skills" name="technical_skills" rows="3" 
                                          placeholder="e.g. Tally, Excel, Programming Languages, etc."></textarea>
                                <div class="field-help">Separate skills with commas</div>
                            </div>
                            <div class="mb-3">
                                <label for="teaching_subjects" class="form-label">Teaching Subjects (For Trainers)</label>
                                <textarea class="form-control" id="teaching_subjects" name="teaching_subjects" rows="2" 
                                          placeholder="e.g. Tally ERP, Excel, Accounting, etc."></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="languages_known" class="form-label">Languages Known</label>
                                <input type="text" class="form-control" id="languages_known" name="languages_known" 
                                       placeholder="e.g. English, Hindi, Kannada">
                            </div>
                        </div>

                        <div class="form-section">
                            <h6><i class="fas fa-rupee-sign"></i>Bank & Identity Details</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="pan_number" class="form-label">PAN Number</label>
                                        <input type="text" class="form-control" id="pan_number" name="pan_number" 
                                               pattern="[A-Z]{5}[0-9]{4}[A-Z]{1}" title="Please enter a valid PAN number" 
                                               style="text-transform: uppercase;">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="aadhar_number" class="form-label">Aadhar Number</label>
                                        <input type="text" class="form-control" id="aadhar_number" name="aadhar_number" 
                                               pattern="[0-9]{12}" title="Please enter a valid 12-digit Aadhar number">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="bank_account_number" class="form-label">Bank Account Number</label>
                                        <input type="text" class="form-control" id="bank_account_number" name="bank_account_number">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="bank_name" class="form-label">Bank Name</label>
                                        <input type="text" class="form-control" id="bank_name" name="bank_name">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="bank_ifsc" class="form-label">IFSC Code</label>
                                        <input type="text" class="form-control" id="bank_ifsc" name="bank_ifsc" 
                                               pattern="[A-Z]{4}[0-9]{7}" title="Please enter a valid IFSC code" 
                                               style="text-transform: uppercase;">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 4: Documents Upload -->
            <div class="wizard-step" data-step="4">
                <div class="row">
                    <div class="col-lg-8 mx-auto">
                        <div class="form-section">
                            <h6><i class="fas fa-camera"></i>Profile Photo</h6>
                            <div class="text-center mb-3">
                                <img id="avatarPreview" src="https://via.placeholder.com/100x100/007bff/white?text=Photo" 
                                     alt="Profile Preview" class="avatar-preview">
                            </div>
                            <div class="file-upload-area" id="photoUploadArea">
                                <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
                                <p class="mb-2">Drag & drop a photo here or click to select</p>
                                <input type="file" id="profile_photo" name="profile_photo" accept="image/*" style="display: none;">
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="document.getElementById('profile_photo').click()">
                                    <i class="fas fa-image me-1"></i>Choose Photo
                                </button>
                                <div class="field-help mt-2">Supported formats: JPG, PNG, GIF (Max: 2MB)</div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h6><i class="fas fa-file-alt"></i>Documents Upload</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="resume_file" class="form-label">Resume/CV</label>
                                        <input type="file" class="form-control" id="resume_file" name="resume_file" 
                                               accept=".pdf,.doc,.docx">
                                        <div class="field-help">PDF, DOC, DOCX files only (Max: 5MB)</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="id_proof_file" class="form-label">ID Proof</label>
                                        <input type="file" class="form-control" id="id_proof_file" name="id_proof_file" 
                                               accept=".pdf,.jpg,.jpeg,.png">
                                        <div class="field-help">Aadhar, PAN, Passport, etc.</div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="address_proof_file" class="form-label">Address Proof</label>
                                        <input type="file" class="form-control" id="address_proof_file" name="address_proof_file" 
                                               accept=".pdf,.jpg,.jpeg,.png">
                                        <div class="field-help">Utility bill, Bank statement, etc.</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="educational_certificates" class="form-label">Educational Certificates</label>
                                        <input type="file" class="form-control" id="educational_certificates" name="educational_certificates[]" 
                                               multiple accept=".pdf,.jpg,.jpeg,.png">
                                        <div class="field-help">Degree, Diploma certificates</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h6><i class="fas fa-sticky-note"></i>Additional Notes</h6>
                            <div class="mb-3">
                                <label for="notes" class="form-label">General Notes</label>
                                <textarea class="form-control" id="notes" name="notes" rows="3" 
                                          placeholder="Any additional information about this staff member..."></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="hobbies_interests" class="form-label">Hobbies & Interests</label>
                                <input type="text" class="form-control" id="hobbies_interests" name="hobbies_interests" 
                                       placeholder="e.g. Reading, Sports, Music">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 5: Review & Submit -->
            <div class="wizard-step" data-step="5">
                <div class="row">
                    <div class="col-lg-8 mx-auto">
                        <div class="summary-card">
                            <h5 class="mb-3"><i class="fas fa-clipboard-check me-2"></i>Review Staff Information</h5>
                            <p class="mb-0">Please review all the information before submitting. You can go back to make changes if needed.</p>
                        </div>

                        <div class="form-section">
                            <h6><i class="fas fa-user"></i>Basic Information</h6>
                            <div id="reviewBasicInfo">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>

                        <div class="form-section">
                            <h6><i class="fas fa-id-card"></i>Personal Details</h6>
                            <div id="reviewPersonalInfo">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>

                        <div class="form-section">
                            <h6><i class="fas fa-briefcase"></i>Professional Information</h6>
                            <div id="reviewProfessionalInfo">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>

                        <div class="form-section">
                            <h6><i class="fas fa-file-upload"></i>Documents</h6>
                            <div id="reviewDocuments">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Wizard Controls -->
            <div class="d-flex justify-content-between p-3 border-top">
                <button type="button" class="btn btn-outline-secondary btn-wizard" id="prevBtn" onclick="changeStep(-1)" style="display: none;">
                    <i class="fas fa-arrow-left me-1"></i>Previous
                </button>
                <div class="flex-fill"></div>
                <button type="button" class="btn btn-primary btn-wizard" id="nextBtn" onclick="changeStep(1)">
                    Next<i class="fas fa-arrow-right ms-1"></i>
                </button>
                <button type="submit" class="btn btn-success btn-wizard" id="submitBtn" style="display: none;">
                    <i class="fas fa-check me-1"></i>Create Staff Member
                </button>
            </div>
        </form>
    </div>
</div>

<script>
let currentStep = 1;
const totalSteps = 5;

function changeStep(direction) {
    const currentStepElement = document.querySelector(`.wizard-step[data-step="${currentStep}"]`);
    const currentNavElement = document.querySelector(`.nav-link[data-step="${currentStep}"]`);
    
    // Validate current step before proceeding
    if (direction > 0 && !validateStep(currentStep)) {
        return;
    }
    
    // Hide current step
    currentStepElement.classList.remove('active');
    
    // Mark current step as completed if moving forward
    if (direction > 0) {
        currentNavElement.classList.add('completed');
    }
    
    // Update current step
    currentStep += direction;
    
    // Show new step
    const newStepElement = document.querySelector(`.wizard-step[data-step="${currentStep}"]`);
    const newNavElement = document.querySelector(`.nav-link[data-step="${currentStep}"]`);
    
    newStepElement.classList.add('active');
    
    // Update navigation
    document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
    newNavElement.classList.add('active');
    
    // Update progress bar
    const progress = (currentStep / totalSteps) * 100;
    document.getElementById('progressBar').style.width = progress + '%';
    
    // Update buttons
    updateButtons();
    
    // Populate review section if on final step
    if (currentStep === 5) {
        populateReviewSection();
    }
}

function updateButtons() {
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const submitBtn = document.getElementById('submitBtn');
    
    // Show/hide previous button
    if (currentStep === 1) {
        prevBtn.style.display = 'none';
    } else {
        prevBtn.style.display = 'inline-block';
    }
    
    // Show/hide next/submit buttons
    if (currentStep === totalSteps) {
        nextBtn.style.display = 'none';
        submitBtn.style.display = 'inline-block';
    } else {
        nextBtn.style.display = 'inline-block';
        submitBtn.style.display = 'none';
    }
}

function validateStep(step) {
    const stepElement = document.querySelector(`.wizard-step[data-step="${step}"]`);
    const requiredFields = stepElement.querySelectorAll('[required]');
    
    let isValid = true;
    
    requiredFields.forEach(field => {
        if (!field.value.trim()) {
            field.classList.add('is-invalid');
            isValid = false;
        } else {
            field.classList.remove('is-invalid');
        }
    });
    
    // Additional validation for step 1
    if (step === 1) {
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirm_password').value;
        
        if (password !== confirmPassword) {
            document.getElementById('confirm_password').classList.add('is-invalid');
            alert('Passwords do not match!');
            isValid = false;
        }
        
        const username = document.getElementById('username').value;
        if (!/^[a-zA-Z0-9_]+$/.test(username)) {
            document.getElementById('username').classList.add('is-invalid');
            alert('Username can only contain letters, numbers, and underscores.');
            isValid = false;
        }
    }
    
    if (!isValid) {
        alert('Please fill in all required fields correctly.');
    }
    
    return isValid;
}

function populateReviewSection() {
    // Basic Information
    const basicInfo = `
        <div class="summary-item">
            <strong>Full Name:</strong>
            <span>${document.getElementById('full_name').value || 'Not provided'}</span>
        </div>
        <div class="summary-item">
            <strong>Username:</strong>
            <span>${document.getElementById('username').value || 'Not provided'}</span>
        </div>
        <div class="summary-item">
            <strong>Role:</strong>
            <span>${document.getElementById('role').selectedOptions[0]?.text || 'Not selected'}</span>
        </div>
        <div class="summary-item">
            <strong>Designation:</strong>
            <span>${document.getElementById('designation').value || 'Not provided'}</span>
        </div>
    `;
    document.getElementById('reviewBasicInfo').innerHTML = basicInfo;
    
    // Personal Information
    const personalInfo = `
        <div class="summary-item">
            <strong>Primary Mobile:</strong>
            <span>${document.getElementById('primary_mobile').value || 'Not provided'}</span>
        </div>
        <div class="summary-item">
            <strong>Personal Email:</strong>
            <span>${document.getElementById('personal_email').value || 'Not provided'}</span>
        </div>
        <div class="summary-item">
            <strong>Date of Birth:</strong>
            <span>${document.getElementById('date_of_birth').value || 'Not provided'}</span>
        </div>
        <div class="summary-item">
            <strong>City:</strong>
            <span>${document.getElementById('city').value || 'Not provided'}</span>
        </div>
    `;
    document.getElementById('reviewPersonalInfo').innerHTML = personalInfo;
    
    // Professional Information
    const professionalInfo = `
        <div class="summary-item">
            <strong>Joining Date:</strong>
            <span>${document.getElementById('joining_date').value || 'Not provided'}</span>
        </div>
        <div class="summary-item">
            <strong>Employment Type:</strong>
            <span>${document.getElementById('employment_type').selectedOptions[0]?.text || 'Not selected'}</span>
        </div>
        <div class="summary-item">
            <strong>Highest Qualification:</strong>
            <span>${document.getElementById('highest_qualification').selectedOptions[0]?.text || 'Not selected'}</span>
        </div>
        <div class="summary-item">
            <strong>Experience:</strong>
            <span>${document.getElementById('years_of_experience').value || '0'} years</span>
        </div>
    `;
    document.getElementById('reviewProfessionalInfo').innerHTML = professionalInfo;
    
    // Documents
    const documents = [];
    if (document.getElementById('profile_photo').files.length > 0) {
        documents.push('Profile Photo');
    }
    if (document.getElementById('resume_file').files.length > 0) {
        documents.push('Resume/CV');
    }
    if (document.getElementById('id_proof_file').files.length > 0) {
        documents.push('ID Proof');
    }
    
    const documentsInfo = documents.length > 0 
        ? documents.map(doc => `<span class="badge bg-success me-1">${doc}</span>`).join('')
        : '<span class="text-muted">No documents uploaded</span>';
    
    document.getElementById('reviewDocuments').innerHTML = documentsInfo;
}

// Profile photo preview
document.getElementById('profile_photo').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('avatarPreview').src = e.target.result;
        };
        reader.readAsDataURL(file);
    }
});

// Drag and drop for photo upload
const photoUploadArea = document.getElementById('photoUploadArea');
photoUploadArea.addEventListener('dragover', function(e) {
    e.preventDefault();
    this.classList.add('dragover');
});

photoUploadArea.addEventListener('dragleave', function() {
    this.classList.remove('dragover');
});

photoUploadArea.addEventListener('drop', function(e) {
    e.preventDefault();
    this.classList.remove('dragover');
    
    const files = e.dataTransfer.files;
    if (files.length > 0 && files[0].type.startsWith('image/')) {
        document.getElementById('profile_photo').files = files;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('avatarPreview').src = e.target.result;
        };
        reader.readAsDataURL(files[0]);
    }
});

// Form submission
document.getElementById('createStaffForm').addEventListener('submit', function(e) {
    if (!validateStep(5)) {
        e.preventDefault();
    } else {
        // Show loading state
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Creating...';
        submitBtn.disabled = true;
    }
});

// Initialize
updateButtons();
</script>
{% endblock %}
