{% extends "base.html" %}

{% block title %}Financial Reports - Global IT Education{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-1">
                        Financial Reports 
                        <span class="badge bg-primary ms-2">{{ report_type.title() }} View</span>
                    </h1>
                    <p class="text-muted">
                        {% if report_type == 'summary' %}
                            Basic financial overview with payment method and branch breakdowns
                        {% elif report_type == 'detailed' %}
                            Comprehensive analytics with daily breakdowns and detailed insights
                        {% elif report_type == 'comparison' %}
                            Period-over-period comparison analysis
                        {% endif %}
                    </p>
                </div>
                <div>
                    <a href="{{ url_for('finance.dashboard') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Back to Finance Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Date Range Filter -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <form method="GET" class="row g-3">
                        <div class="col-md-3">
                            <label for="date_from" class="form-label">From Date</label>
                            <input type="date" class="form-control" id="date_from" name="date_from" value="{{ date_from }}">
                        </div>
                        <div class="col-md-3">
                            <label for="date_to" class="form-label">To Date</label>
                            <input type="date" class="form-control" id="date_to" name="date_to" value="{{ date_to }}">
                        </div>
                        <div class="col-md-3">
                            <label for="type" class="form-label">Report Type</label>
                            <select class="form-select" id="type" name="type">
                                <option value="summary" {{ 'selected' if report_type == 'summary' }}>Summary</option>
                                <option value="detailed" {{ 'selected' if report_type == 'detailed' }}>Detailed</option>
                                <option value="comparison" {{ 'selected' if report_type == 'comparison' }}>Comparison</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search me-2"></i>Generate Report
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Total Collection</h6>
                            <h3 class="mb-0">₹{{ "{:,.2f}".format(total_collected) }}</h3>
                            <small>{{ payment_count }} payments</small>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-rupee-sign fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Average Payment</h6>
                            <h3 class="mb-0">₹{{ "{:,.2f}".format(average_payment) }}</h3>
                            <small>Per transaction</small>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-chart-line fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Period</h6>
                            <h3 class="mb-0">{{ period_days }}</h3>
                            <small>Days selected</small>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-calendar fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Comparison Data (only for comparison report type) -->
    {% if report_type == 'comparison' and comparison_data %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-bar me-2"></i>Period Comparison
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Current Period ({{ date_from }} to {{ date_to }})</h6>
                            <p>Total: ₹{{ "{:,.2f}".format(comparison_data.current_period.total) }}</p>
                            <p>Payments: {{ comparison_data.current_period.count }}</p>
                        </div>
                        <div class="col-md-6">
                            <h6>Previous Period ({{ comparison_data.period_label }})</h6>
                            <p>Total: ₹{{ "{:,.2f}".format(comparison_data.previous_period.total) }}</p>
                            <p>Payments: {{ comparison_data.previous_period.count }}</p>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h5 class="card-title text-{{ 'success' if comparison_data.growth.amount >= 0 else 'danger' }}">
                                        {{ "{:+.1f}%".format(comparison_data.growth.amount) }}
                                    </h5>
                                    <p class="card-text">Amount Growth</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h5 class="card-title text-{{ 'success' if comparison_data.growth.count >= 0 else 'danger' }}">
                                        {{ "{:+.1f}%".format(comparison_data.growth.count) }}
                                    </h5>
                                    <p class="card-text">Payment Count Growth</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="row">
        <!-- Payment Method Breakdown -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-credit-card me-2"></i>Payment Method Breakdown
                    </h5>
                </div>
                <div class="card-body">
                    {% if method_breakdown %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Payment Method</th>
                                    <th>Amount</th>
                                    <th>Count</th>
                                    <th>%</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for method, amount, count, percentage in method_breakdown %}
                                <tr>
                                    <td>
                                        <span class="badge bg-secondary">{{ method.upper() }}</span>
                                    </td>
                                    <td>₹{{ "{:,.2f}".format(amount) }}</td>
                                    <td>{{ count }}</td>
                                    <td>{{ "{:.1f}%".format(percentage) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-chart-pie fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No payment data available for the selected period</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Branch-wise Breakdown -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-building me-2"></i>Branch-wise Collection
                    </h5>
                </div>
                <div class="card-body">
                    {% if branch_breakdown %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Branch</th>
                                    <th>Amount</th>
                                    <th>Payments</th>
                                    <th>%</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for branch_name, amount, count, percentage in branch_breakdown %}
                                <tr>
                                    <td>{{ branch_name }}</td>
                                    <td>₹{{ "{:,.2f}".format(amount) }}</td>
                                    <td>{{ count }}</td>
                                    <td>{{ "{:.1f}%".format(percentage) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-building fa-3x text-muted mb-3"></i>
                        <p class="text-muted">{{ "No branch data available" if session.get('role') in ['admin', 'manager'] else "Branch-specific view for current user" }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Daily Breakdown (only for detailed report type) -->
    {% if report_type == 'detailed' %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-calendar-day me-2"></i>Daily Collection Breakdown
                    </h5>
                </div>
                <div class="card-body">
                    {% if daily_breakdown %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Date</th>
                                    <th>Amount Collected</th>
                                    <th>Number of Payments</th>
                                    <th>Average per Payment</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for date, amount, count in daily_breakdown %}
                                <tr>
                                    <td>{{ date }}</td>
                                    <td>₹{{ "{:,.2f}".format(amount) }}</td>
                                    <td>{{ count }}</td>
                                    <td>₹{{ "{:,.2f}".format(amount / count if count > 0 else 0) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No daily breakdown data available for the selected period</p>
                        <small class="text-muted">This could be because there are no payments in this date range</small>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Additional Reports Section -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-download me-2"></i>Export Options
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="d-grid">
                                <a href="{{ url_for('finance.financial_reports', date_from=date_from, date_to=date_to, type=report_type, export='pdf') }}" 
                                   class="btn btn-outline-danger">
                                    <i class="fas fa-file-pdf me-2"></i>Export as PDF
                                </a>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-grid">
                                <a href="{{ url_for('finance.financial_reports', date_from=date_from, date_to=date_to, type=report_type, export='excel') }}" 
                                   class="btn btn-outline-success">
                                    <i class="fas fa-file-excel me-2"></i>Export as Excel
                                </a>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-grid">
                                <button class="btn btn-outline-primary" onclick="window.print()">
                                    <i class="fas fa-print me-2"></i>Print Report
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-bar me-2"></i>Quick Statistics
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="border-end">
                                <h4 class="text-primary">₹{{ "{:,.0f}".format(daily_average) }}</h4>
                                <small class="text-muted">Daily Average</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border-end">
                                <h4 class="text-success">{{ "{:.1f}".format(daily_payments) }}</h4>
                                <small class="text-muted">Payments/Day</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border-end">
                                <h4 class="text-info">{{ method_count }}</h4>
                                <small class="text-muted">Payment Methods</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <h4 class="text-warning">{{ branch_count }}</h4>
                            <small class="text-muted">Active Branches</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
@media print {
    .btn, .card-header, .navbar, .sidebar {
        display: none !important;
    }
    .card {
        border: none !important;
        box-shadow: none !important;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set default date range if not provided
    const dateFrom = document.getElementById('date_from');
    const dateTo = document.getElementById('date_to');
    
    if (!dateFrom.value || !dateTo.value) {
        const today = new Date();
        const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
        
        if (!dateFrom.value) {
            dateFrom.value = thirtyDaysAgo.toISOString().split('T')[0];
        }
        if (!dateTo.value) {
            dateTo.value = today.toISOString().split('T')[0];
        }
    }
});
</script>
{% endblock %}
