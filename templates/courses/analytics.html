{% extends "base.html" %}

{% block title %}Course Analytics{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/modules/course-management.css') }}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1">
                        <i class="bi bi-graph-up text-primary"></i> Course Analytics
                    </h2>
                    <p class="text-muted mb-0">Performance metrics and insights for your course offerings</p>
                </div>
                <div>
                    <a href="{{ url_for('courses.list_courses') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Back to Courses
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title mb-1">Total Courses</h5>
                            <h3 class="mb-0">{{ courses_stats|length }}</h3>
                        </div>
                        <i class="bi bi-mortarboard" style="font-size: 2rem; opacity: 0.7;"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title mb-1">Total Students</h5>
                            <h3 class="mb-0">
                                {% set total_students = courses_stats|sum(attribute='total_students') %}
                                {{ total_students or 0 }}
                            </h3>
                        </div>
                        <i class="bi bi-people" style="font-size: 2rem; opacity: 0.7;"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title mb-1">Total Revenue</h5>
                            <h3 class="mb-0">
                                {% set total_revenue = courses_stats|sum(attribute='total_revenue') %}
                                ₹{{ "{:,.0f}".format(total_revenue or 0) }}
                            </h3>
                        </div>
                        <i class="bi bi-currency-rupee" style="font-size: 2rem; opacity: 0.7;"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title mb-1">Active Batches</h5>
                            <h3 class="mb-0">
                                {% set total_batches = courses_stats|sum(attribute='total_batches') %}
                                {{ total_batches or 0 }}
                            </h3>
                        </div>
                        <i class="bi bi-calendar-check" style="font-size: 2rem; opacity: 0.7;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Courses by Category</h5>
                </div>
                <div class="card-body">
                    <canvas id="categoryChart" style="max-height: 300px;"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Revenue by Category</h5>
                </div>
                <div class="card-body">
                    <canvas id="revenueChart" style="max-height: 300px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Category-wise Performance -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-grid"></i> Category-wise Performance</h5>
                </div>
                <div class="card-body">
                    {% if category_stats %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th class="text-center">Course Count</th>
                                    <th class="text-end">Total Revenue</th>
                                    <th class="text-end">Avg Revenue per Course</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for stat in category_stats %}
                                <tr>
                                    <td>
                                        <span class="badge bg-primary">{{ stat.category or 'Uncategorized' }}</span>
                                    </td>
                                    <td class="text-center">{{ stat.course_count }}</td>
                                    <td class="text-end">₹{{ "{:,.0f}".format(stat.category_revenue or 0) }}</td>
                                    <td class="text-end">
                                        {% if stat.course_count > 0 %}
                                        ₹{{ "{:,.0f}".format((stat.category_revenue or 0) / stat.course_count) }}
                                        {% else %}
                                        ₹0
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-pie-chart text-muted" style="font-size: 3rem;"></i>
                        <h5 class="text-muted mt-3">No category data available</h5>
                        <p class="text-muted">Create some courses to see category analytics</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Individual Course Performance -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-list-ul"></i> Individual Course Performance</h5>
                </div>
                <div class="card-body">
                    {% if courses_stats %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Course Name</th>
                                    <th>Category</th>
                                    <th class="text-end">Course Fee</th>
                                    <th class="text-center">Students</th>
                                    <th class="text-center">Batches</th>
                                    <th class="text-end">Revenue</th>
                                    <th class="text-end">ROI</th>
                                    <th class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for course in courses_stats %}
                                <tr>
                                    <td>
                                        <strong>{{ course.course_name }}</strong>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">{{ course.category or 'Uncategorized' }}</span>
                                    </td>
                                    <td class="text-end">₹{{ "{:,.0f}".format(course.fee) }}</td>
                                    <td class="text-center">
                                        <span class="badge bg-info">{{ course.total_students or 0 }}</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-success">{{ course.total_batches or 0 }}</span>
                                    </td>
                                    <td class="text-end">₹{{ "{:,.0f}".format(course.total_revenue or 0) }}</td>
                                    <td class="text-end">
                                        {% if course.total_students and course.total_students > 0 %}
                                        <span class="text-success">
                                            {{ "{:.1f}".format(((course.total_revenue or 0) / course.total_students) / course.fee * 100) }}%
                                        </span>
                                        {% else %}
                                        <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a href="{{ url_for('courses.view_course', course_id=course.id) }}" 
                                               class="btn btn-outline-primary" title="View Course">
                                                <i class="bi bi-eye"></i>
                                            </a>
                                            {% if session.role == 'admin' %}
                                            <a href="{{ url_for('courses.edit_course_form', course_id=course.id) }}" 
                                               class="btn btn-outline-secondary" title="Edit Course">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-mortarboard text-muted" style="font-size: 4rem;"></i>
                        <h4 class="text-muted mt-3">No Course Data Available</h4>
                        <p class="text-muted">Create some courses to see performance analytics</p>
                        {% if session.role == 'admin' %}
                        <a href="{{ url_for('courses.create_course_form') }}" class="btn btn-primary">
                            <i class="bi bi-plus-lg"></i> Create Your First Course
                        </a>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Category Chart Data
    const categoryData = [
        {% for stat in category_stats %}
        {
            label: '{{ stat.category or "Uncategorized" }}',
            count: {{ stat.course_count }},
            revenue: {{ stat.category_revenue or 0 }}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];

    // Colors for charts
    const colors = [
        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
        '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
    ];

    // Category Distribution Pie Chart
    if (document.getElementById('categoryChart') && categoryData.length > 0) {
        const ctx1 = document.getElementById('categoryChart').getContext('2d');
        new Chart(ctx1, {
            type: 'doughnut',
            data: {
                labels: categoryData.map(item => item.label),
                datasets: [{
                    data: categoryData.map(item => item.count),
                    backgroundColor: colors,
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return `${label}: ${value} courses (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    // Revenue by Category Bar Chart
    if (document.getElementById('revenueChart') && categoryData.length > 0) {
        const ctx2 = document.getElementById('revenueChart').getContext('2d');
        new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: categoryData.map(item => item.label),
                datasets: [{
                    label: 'Revenue (₹)',
                    data: categoryData.map(item => item.revenue),
                    backgroundColor: colors,
                    borderColor: colors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `Revenue: ₹${context.parsed.y.toLocaleString()}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '₹' + value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
    }

    // Add empty state for charts if no data
    if (categoryData.length === 0) {
        const emptyMessage = '<div class="text-center py-4"><i class="bi bi-pie-chart text-muted" style="font-size: 3rem;"></i><h5 class="text-muted mt-3">No data available</h5><p class="text-muted">Create some courses to see analytics</p></div>';
        
        document.getElementById('categoryChart').parentElement.innerHTML = emptyMessage;
        document.getElementById('revenueChart').parentElement.innerHTML = emptyMessage;
    }
});
</script>
{% endblock %}
